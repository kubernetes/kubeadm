# AUTOGENERATED by https://git.k8s.io/kubeadm/kinder/ci/tools/update-workflows
# IMPORTANT! this workflow is imported by external-ca-* workflows.
version: 1
summary: |
  This workflow implements a sequence of tasks for testing the external-ca functionality.
vars:
  # vars defines default values for variable used by tasks in this workflow;
  # those values might be overridden when importing this files.
  kubernetesVersion: v1.16.0
  baseImage: kindest/base:v20221102-76f15095 # has containerd
  image: kindest/node:test
  clusterName: kinder-external-ca
  kubeadmVerbosity: 6
tasks:
  - name: pull-base-image
    description: |
      pulls kindest/base image with docker in docker and all the prerequisites necessary for running kind(er)
    cmd: docker
    args:
      - pull
      - "{{ .vars.baseImage }}"
  - name: add-kubernetes-versions
    description: |
      creates a node-image-variant by adding Kubernetes version "kubernetesVersion"
      to be used when executing "kinder do kubeadm-init"
    cmd: kinder
    args:
      - build
      - node-image-variant
      - --base-image={{ .vars.baseImage }}
      - --image={{ .vars.image }}
      - --with-init-artifacts={{ .vars.kubernetesVersion }}
      - --with-upgrade-artifacts={{ .vars.kubernetesVersion }}
      - --loglevel=debug
    timeout: 15m
  - name: create-cluster
    description: |
      create a set of Nodes ready for hosting the Kubernetes cluster
    cmd: kinder
    args:
      - create
      - cluster
      - --name={{ .vars.clusterName }}
      - --image={{ .vars.image }}
      - --control-plane-nodes=3
      - --worker-nodes=2
      - --loglevel=debug
    timeout: 5m
  - name: setup-external-ca
    description: |
      Prepares the nodes in the cluster with certificates and kubeconfig files so that the
      cluster can start without the root ca.key file
    cmd: kinder
    args:
      - do
      - setup-external-ca
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
      - --kubeadm-verbosity={{ .vars.kubeadmVerbosity }}
  - name: init
    description: |
      Initializes the Kubernetes cluster with version "kubernetesVersion"
      by starting the bootstrap control-plane node
    cmd: kinder
    args:
      - do
      - kubeadm-init
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
      - --kubeadm-verbosity={{ .vars.kubeadmVerbosity }}
    timeout: 5m
  - name: join
    description: |
      Join the other nodes to the Kubernetes cluster
    cmd: kinder
    args:
      - do
      - kubeadm-join
      - --copy-certs=none # skip certificate copy since "setup-external-ca" manages that
      - --name={{ .vars.clusterName }}
      # skip the errors for existing kubelet.conf and ca.cert because they were generated by "setup-external-ca"
      # the rest are kinder defaults
      - --ignore-preflight-errors=FileAvailable--etc-kubernetes-kubelet.conf,FileAvailable--etc-kubernetes-pki-ca.crt,Swap,SystemVerification,FileContent--proc-sys-net-bridge-bridge-nf-call-iptables
      - --loglevel=debug
      - --kubeadm-verbosity={{ .vars.kubeadmVerbosity }}
    timeout: 10m
  - name: cluster-info-before
    description: |
      Runs cluster-info on the cluster before upgrade
    cmd: kinder
    args:
      - do
      - cluster-info
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
  - name: e2e-kubeadm-before
    description: |
      Runs kubeadm e2e test on the cluster before upgrade
    cmd: kinder
    args:
      - test
      - e2e-kubeadm
      - --test-flags=--report-dir={{ .env.ARTIFACTS }} --report-prefix=e2e-kubeadm
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
    timeout: 10m
  - name: upgrade
    description: |
      upgrades the cluster to the same version
    cmd: kinder
    args:
      - do
      - kubeadm-upgrade
      - --upgrade-version={{ .vars.kubernetesVersion }}
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
      - --kubeadm-verbosity={{ .vars.kubeadmVerbosity }}
      - --ignore-preflight-errors=SystemVerification
    timeout: 15m
  - name: cluster-info-after
    description: |
      Runs cluster-info on the cluster after upgrade
    cmd: kinder
    args:
      - do
      - cluster-info
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
  - name: e2e-kubeadm-after
    description: |
      Runs kubeadm e2e test on the cluster after upgrade
    cmd: kinder
    args:
      - test
      - e2e-kubeadm
      - --test-flags=--report-dir={{ .env.ARTIFACTS }} --report-prefix=e2e-kubeadm
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
    timeout: 10m
  - name: e2e-after
    description: |
      Runs Kubernetes e2e test (conformance) on the cluster with Kubernetes "upgradeVersion"
    cmd: kinder
    args:
      - test
      - e2e
      - --test-flags=--report-dir={{ .env.ARTIFACTS }} --report-prefix=e2e
      - --parallel
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
    timeout: 35m
  - name: get-logs
    description: |
      Collects all the test logs
    cmd: kinder
    args:
      - export
      - logs
      - --loglevel=debug
      - --name={{ .vars.clusterName }}
      - "{{ .env.ARTIFACTS }}"
    force: true
    timeout: 5m
    ignoreError: true
  - name: reset
    description: |
      Exec kubeadm reset
    cmd: kinder
    args:
      - do
      - kubeadm-reset
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
      - --kubeadm-verbosity={{ .vars.kubeadmVerbosity }}
    force: true
  - name: delete
    description: |
      Deletes the cluster
    cmd: kinder
    args:
      - delete
      - cluster
      - --name={{ .vars.clusterName }}
      - --loglevel=debug
    force: true
